<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="KVwuc0VgACwZZ4b0ur14TDVKWXZAMI_Hw-OditT2g10">

















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=7.0.1">


  <link rel="mask-icon" href="/logo.svg?v=7.0.1" color="#222">


  <link rel="manifest" href="/manifest.json">


  <meta name="msapplication-config" content="/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




<link href="https://cdn.bootcss.com/mermaid/7.0.14/themes/mermaid.forest.min.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="https://cdn.bootcss.com/mermaid/7.0.14/mermaid.min.js"></script>

<style>

div.mermaid .label{
  text-align: center;
}

@media print {
  body * {
    visibility: hidden;
  }

  .post-block, .post-block * {
    visibility: visible;
  }

  .post-block {
    position: absolute;
    left: 0;
    top: 0;
  }

  .post-copyright, .post-copyright *  {
    visibility: hidden;
  }
  .post-footer, .post-footer *  {
    visibility: hidden;
  }
  .post-meta, .post-meta *  {
    visibility: hidden;
  }
}
</style>


  <meta name="description" content="Configure VPCAs there is no auth to connect to Redis server, all security policy are based on VPC‘s Security Group, so before setup Redis server, we have to configure the VPC.  Sign in to VPC Console,">
<meta name="keywords" content="AWS,Redis,ElastiCache,Lambda">
<meta property="og:type" content="article">
<meta property="og:title" content="Amazon ElastiCache for Redis in Lambda">
<meta property="og:url" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/index.html">
<meta property="og:site_name" content="I&#39;m Yang">
<meta property="og:description" content="Configure VPCAs there is no auth to connect to Redis server, all security policy are based on VPC‘s Security Group, so before setup Redis server, we have to configure the VPC.  Sign in to VPC Console,">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/sec-group-define.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/elasticache-start.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-region.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-engine.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-setting.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-setting-adv.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-launching.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/cluster-details.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/cluster-metrics.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-sec-group.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-role-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-role-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-role-3.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-role-4.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-3.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-4.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-5.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-6.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-7.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-3.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-4.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-5.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-6.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-7.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-8.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-9.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/lmbda-test-10.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-3.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-4.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-7.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-5.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-sec-group-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-sec-group-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/ec2-6.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-3.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-4.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-5.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-6.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-test-1.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-test-2.png">
<meta property="og:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/redis-replica-test-3.png">
<meta property="og:updated_time" content="2019-03-14T09:07:48.854Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Amazon ElastiCache for Redis in Lambda">
<meta name="twitter:description" content="Configure VPCAs there is no auth to connect to Redis server, all security policy are based on VPC‘s Security Group, so before setup Redis server, we have to configure the VPC.  Sign in to VPC Console,">
<meta name="twitter:image" content="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/sec-group-define.png">






  <link rel="canonical" href="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Amazon ElastiCache for Redis in Lambda | I'm Yang</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">I'm Yang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Yang's Blog</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">28</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">5</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">22</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/wangyfm" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Yang">
      <meta itemprop="description" content="java, microservice">
      <meta itemprop="image" content="/apple-touch-icon.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I'm Yang">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Amazon ElastiCache for Redis in Lambda

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-03 14:00:13" itemprop="dateCreated datePublished" datetime="2018-04-03T14:00:13+08:00">2018-04-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-14 17:07:48" itemprop="dateModified" datetime="2019-03-14T17:07:48+08:00">2019-03-14</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/04/03/aws-elasti-cache-lambda/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2018/04/03/aws-elasti-cache-lambda/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Configure-VPC"><a href="#Configure-VPC" class="headerlink" title="Configure VPC"></a>Configure VPC</h2><p>As there is no auth to connect to Redis server, all security policy are based on <strong>VPC</strong>‘s <strong>Security Group</strong>, so before setup Redis server, we have to configure the VPC.</p>
<ol>
<li>Sign in to <a href="https://console.aws.amazon.com/vpc" target="_blank" rel="noopener">VPC Console</a>, make sure there is at least one VPC</li>
<li>Open <strong>Security Group</strong>, create a new Security Group<br><img src="/2018/04/03/aws-elasti-cache-lambda/sec-group-define.png" alt="sec-group-define.png"><br><strong>Note</strong>: The <em>VPC</em> should be used same one in the following configuration</li>
</ol>
<h2 id="Launch-a-Redis-Cluster"><a href="#Launch-a-Redis-Cluster" class="headerlink" title="Launch a Redis Cluster"></a>Launch a Redis Cluster</h2><p>Amazon ElastiCache for Redis clusters provide a variety of node configurations:</p>
<ol>
<li>Single Node</li>
<li>Single Shard Multiple Nodes<br>A single shard configuration groups up to 6 nodes in a single cluster, a read/write Primary node and up to 5 read-only Replica nodes.</li>
<li>Multiple Shards Multiple Nodes<br>A multiple shard configuration partitions your data across up to 20 shards in the cluster. Each shard has a read/write Primary node and up to 5 read-only replica nodes.</li>
</ol>
<p>Now we setup a ‘Single Node’ Redis Cluster:</p>
<ol>
<li>Sign in to <a href="https://console.aws.amazon.com/elasticache" target="_blank" rel="noopener">ElastiCache Console</a></li>
<li>Choose Get Started Now.<br><img src="/2018/04/03/aws-elasti-cache-lambda/elasticache-start.png" alt="elasticache-start.png"></li>
<li>Choose the region<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-region.png" alt="redis-region.png"></li>
<li>Choose <strong>Redis</strong> as cluster engine<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-engine.png" alt="redis-engine.png"></li>
<li>Complete ‘Redis settings’<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-setting.png" alt="redis-setting.png"><br><strong>Note</strong>: As we are configuring a Single Node Redis, so we set <strong>Number of Replicas</strong> as <em>None</em>.</li>
<li>Complete ‘Advanced Redis settings’<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-setting-adv.png" alt="redis-setting-adv.png"><br><strong>Note</strong>: Keep <strong>VPC ID</strong> same as the VPC configuration, and remember the <em>Subnets</em></li>
<li>The other items are kept as default</li>
<li>Choose <em>Create</em> cluster to launch your cluster<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-launching.png" alt="redis-launching.png"><br>The Create operation will take a while.</li>
<li>View the details of cluster cluster we created<br><img src="/2018/04/03/aws-elasti-cache-lambda/cluster-details.png" alt="cluster-details.png"><br><code>Primary Endpoint</code> will be configured Redis client for connecting Redis server.</li>
<li>Click on the cluster’s name, the node(s) in the cluster will be listed, and you can see the metrics of each node<br><img src="/2018/04/03/aws-elasti-cache-lambda/cluster-metrics.png" alt="cluster-metrics.png"></li>
<li>The main step is checking the <strong>Security Group</strong>, make sure the its same as we created:<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-sec-group.png" alt="redis-sec-group.png"></li>
</ol>
<p>Now the Redis Server on AWS is up.</p>
<h2 id="Prepare-Role-to-Run-Lambda"><a href="#Prepare-Role-to-Run-Lambda" class="headerlink" title="Prepare Role to Run Lambda"></a>Prepare Role to Run Lambda</h2><ol>
<li>Sign in to <a href="https://console.aws.amazon.com/iam" target="_blank" rel="noopener">IAM Console</a></li>
<li>To create a new Role:</li>
<li>Choose <em>AWS Service</em> as role type, and <em>Lambda</em> as service<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-role-1.png" alt="lmbda-role-1.png"></li>
<li>Selected <em>AWSLambdaVPCAccessExecutionRole</em> at step of <em>Attach permissions policies</em><br>This permission is enough for us to connect to Redis server in Lambda function.<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-role-2.png" alt="lmbda-role-2.png"></li>
<li>Named the role<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-role-3.png" alt="lmbda-role-3.png"></li>
<li>Role is created!<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-role-4.png" alt="lmbda-role-4.png"></li>
</ol>
<h2 id="Lambda-Function"><a href="#Lambda-Function" class="headerlink" title="Lambda Function"></a>Lambda Function</h2><h3 id="Create-Lambda-Function"><a href="#Create-Lambda-Function" class="headerlink" title="Create Lambda Function"></a>Create Lambda Function</h3><ol>
<li>Create a Lambda function<br>User Node.js as dev env, and select the role we just created<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-1.png" alt="lmbda-1.png"></li>
<li>Created Lambda function<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-2.png" alt="lmbda-2.png"></li>
<li>Configure Lambda Role, min required memory or timeout configuration<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-3.png" alt="lmbda-3.png"></li>
<li>Configure Network<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-4.png" alt="lmbda-4.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-5.png" alt="lmbda-5.png"><br><strong>Note</strong>:<ol>
<li><em>VPC</em> must be same as above configuration</li>
<li><em>Subnets</em> must contain the same <em>Subnets</em> when we setup Redis</li>
<li><em>Security Groups</em> must be save as above configuration</li>
</ol>
</li>
</ol>
<h3 id="Write-Lambda-Function-to-connect-to-Redis"><a href="#Write-Lambda-Function-to-connect-to-Redis" class="headerlink" title="Write Lambda Function to connect to Redis"></a>Write Lambda Function to connect to Redis</h3><p>We use <a href="https://www.npmjs.com/package/redis" target="_blank" rel="noopener">node_redis</a> as client to connect Redis server in our Lambda function.</p>
<ol>
<li><p>The project structure is as below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lambda_function</span><br><span class="line">|-- node_modules</span><br><span class="line">|-- package.json</span><br><span class="line">|-- index.js</span><br></pre></td></tr></table></figure>
</li>
<li><p>The dependencies in <code>package.json</code> is:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"main": "index.js",</span><br><span class="line">"dependencies": &#123;</span><br><span class="line">    "bluebird": "^3.5.1",</span><br><span class="line">    "redis": "^2.8.0"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bluebird</code> is for <em>Promise</em> implementation.</p>
</li>
<li><p>The code implementation of Lambda function is in <code>index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> redis = <span class="built_in">require</span>(<span class="string">'redis'</span>);</span><br><span class="line"><span class="keyword">var</span> bluebird = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</span><br><span class="line">bluebird.promisifyAll(redis.RedisClient.prototype);</span><br><span class="line">bluebird.promisifyAll(redis.Multi.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> GLOBAL_KEY = <span class="string">'lambda-test'</span>;</span><br><span class="line"><span class="keyword">const</span> redisOptions = &#123;</span><br><span class="line">    host: <span class="string">"redistest.cbmmpl.0001.use1.cache.amazonaws.com"</span>,</span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">redis.debug_mode = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'Start to connect to Redis Server'</span>)</span><br><span class="line">    <span class="keyword">var</span> client = redis.createClient(redisOptions);</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'Connected to Redis Server'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'event.pathParameters: '</span>, event.pathParameters);</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'event.httpMethod: '</span>, event.httpMethod);</span><br><span class="line">    <span class="keyword">let</span> id = (event.pathParameters || &#123;&#125;).product || <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> data = event.data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.httpMethod) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"GET"</span>:</span><br><span class="line">            <span class="keyword">if</span> (id) &#123;</span><br><span class="line">                <span class="built_in">console</span>.info(<span class="string">'get by id'</span>)</span><br><span class="line">                client.hgetAsync(GLOBAL_KEY, id).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">'Redis responses for get single: '</span>, res);</span><br><span class="line">                    callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:  <span class="string">"This is a READ operation on product ID "</span> + id, <span class="attr">ret</span>: res&#125;);</span><br><span class="line">                    <span class="comment">// callback(null, &#123;body: "This is a READ operation on product ID " + id&#125;);</span></span><br><span class="line">                &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.error(<span class="string">"Failed to get single: "</span>, err)</span><br><span class="line">                    callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">"Failed to get data"</span>&#125;);</span><br><span class="line">                &#125;).finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">'Disconnect to Redis'</span>);</span><br><span class="line">                    client.quit();</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.info(<span class="string">'get all'</span>)</span><br><span class="line">                client.hgetallAsync(GLOBAL_KEY).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">'Redis responses for get all: '</span>, res)</span><br><span class="line">                    callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>: <span class="string">"This is a LIST operation, return all products"</span>, <span class="attr">ret</span>: res&#125;);</span><br><span class="line">                    <span class="comment">// callback(null, &#123;body: "This is a LIST operation, return all products"&#125;);</span></span><br><span class="line">                &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.error(<span class="string">"Failed to post data: "</span>, err)</span><br><span class="line">                    callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">"Failed to get data"</span>&#125;);</span><br><span class="line">                &#125;).finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">'Disconnect to Redis'</span>);</span><br><span class="line">                    client.quit();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"POST"</span>:</span><br><span class="line">            <span class="keyword">if</span> (data) &#123;</span><br><span class="line">                <span class="built_in">console</span>.info(<span class="string">'Posting data for ['</span>, id, <span class="string">'] with value: '</span>, data);</span><br><span class="line">                client.hmsetAsync(GLOBAL_KEY, id, data).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">'Redis responses for post: '</span>, res)</span><br><span class="line">                    callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>: <span class="string">"This is a CREATE operation and it's successful"</span>, <span class="attr">ret</span>: res&#125;);</span><br><span class="line">                    <span class="comment">// callback(null, &#123;body: "This is a CREATE operation"&#125;);</span></span><br><span class="line">                &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.error(<span class="string">"Failed to post data: "</span>, err)</span><br><span class="line">                    callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">"Failed to post data"</span>&#125;);</span><br><span class="line">                &#125;).finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">'Disconnect to Redis'</span>);</span><br><span class="line">                    client.quit();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">'no data is posted'</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"PUT"</span>:</span><br><span class="line">            callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>: <span class="string">"This is an UPDATE operation on product ID "</span> + id&#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"DELETE"</span>:</span><br><span class="line">            <span class="built_in">console</span>.info(<span class="string">'delete a prod'</span>);</span><br><span class="line">            client.delAsync(GLOBAL_KEY).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.info(<span class="string">'Redis responses for get single: '</span>, res);</span><br><span class="line">                callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:  <span class="string">"This is a DELETE operation on product ID "</span> + id, <span class="attr">ret</span>: res&#125;);</span><br><span class="line">                <span class="comment">// callback(null, &#123;body: "This is a DELETE operation on product ID " + id&#125;);</span></span><br><span class="line">            &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">"Failed to delete single: "</span>, err);</span><br><span class="line">                callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">"Failed to delete data"</span>&#125;);</span><br><span class="line">            &#125;).finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.info(<span class="string">'Disconnect to Redis'</span>);</span><br><span class="line">                client.quit();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Send HTTP 501: Not Implemented</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Error: unsupported HTTP method ("</span> + event.httpMethod + <span class="string">")"</span>);</span><br><span class="line">            callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">501</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>redisOptions</code> is from the Redis cluster details.</p>
</li>
<li><p>Package the function<br>First install NPM packages:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>Then zip the files.</p>
</li>
<li>Upload the package:<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-6.png" alt="lmbda-6.png"></li>
<li>Lambda function is deployed:<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-7.png" alt="lmbda-7.png"></li>
</ol>
<h3 id="Test-Lambda-Function"><a href="#Test-Lambda-Function" class="headerlink" title="Test Lambda Function"></a>Test Lambda Function</h3><p>To test the lambda, we need to create some Test Events:</p>
<h4 id="Test-writing-value-to-Redis-Server"><a href="#Test-writing-value-to-Redis-Server" class="headerlink" title="Test writing value to Redis Server"></a>Test writing value to Redis Server</h4><ol>
<li><p>Create Test Event:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"httpMethod"</span>: <span class="string">"POST"</span>,</span><br><span class="line">  <span class="attr">"pathParameters"</span>: &#123;</span><br><span class="line">    <span class="attr">"product"</span>: <span class="string">"key-1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"data"</span>: <span class="string">"I am a test string"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-1.png" alt="lmbda-test-1.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-2.png" alt="lmbda-test-2.png"></p>
</li>
<li>Then clicking <em>Test</em> to mock api call:<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-3.png" alt="lmbda-test-3.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-4.png" alt="lmbda-test-4.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-5.png" alt="lmbda-test-5.png"></li>
<li>We also can view the logs in AWS CloudWatch<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-6.png" alt="lmbda-test-6.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-7.png" alt="lmbda-test-7.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-8.png" alt="lmbda-test-8.png"></li>
</ol>
<h4 id="Test-reading-value-from-Redis-Server"><a href="#Test-reading-value-from-Redis-Server" class="headerlink" title="Test reading value from Redis Server"></a>Test reading value from Redis Server</h4><ol>
<li><p>Create Test Event:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"httpMethod"</span>: <span class="string">"GET"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-9.png" alt="lmbda-test-9.png"></p>
</li>
<li>Then clicking <em>Test</em> to mock api call:<br><img src="/2018/04/03/aws-elasti-cache-lambda/lmbda-test-10.png" alt="lmbda-test-10.png"><br>The value we set is populated from Redis server correctly.</li>
</ol>
<h2 id="Access-ElastiCache-from-EC2"><a href="#Access-ElastiCache-from-EC2" class="headerlink" title="Access ElastiCache from EC2"></a>Access ElastiCache from EC2</h2><p>Excepted AWS Lambda Function, ElastiCache can only be accessed through an Amazon EC2 instance. Below is the step to setup a EC2 instance to access the Redis server:</p>
<ol>
<li>Sign in to <a href="https://console.aws.amazon.com/ec2" target="_blank" rel="noopener">EC2 Console</a></li>
<li>Launch a new Instance<br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-1.png" alt="ec2-1.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-2.png" alt="ec2-2.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-3.png" alt="ec2-3.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-4.png" alt="ec2-4.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-7.png" alt="ec2-7.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-5.png" alt="ec2-5.png"><br>When configuring the instance details, the <em>Network</em> must set the VPC we created, and <em>Subnet</em> must be same as the above Redis.</li>
<li>If the <strong>Security Group</strong> doesn’t contain the same one as Redis server, you have to change the configuration:<br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-sec-group-1.png" alt="ec2-sec-group-1.png"><br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-sec-group-2.png" alt="ec2-sec-group-2.png"></li>
<li>Connect the EC2 instance with <code>ssh</code>:<br><img src="/2018/04/03/aws-elasti-cache-lambda/ec2-6.png" alt="ec2-6.png"></li>
<li><p>Access Redis server through EC2 instance:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redistest.yyyy.xxxx.use1.cache.amazonaws.com</span><br><span class="line">redistest.yyyy.xxxx.use1.cache.amazonaws.com:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">redistest.yyyy.xxxx.use1.cache.amazonaws.com:6379&gt;</span><br></pre></td></tr></table></figure>
<p>When <code>ping</code> responses <code>PONG</code>, it means the EC2 instance has connected to ElastiCache service, now you can deploy/test your application which need Redis service.<br><strong>Note</strong>:For this step, the EC2 instance have to be installed <code>redis-cli</code> tool.</p>
</li>
</ol>
<h2 id="Scalability-of-Amazon-ElastiCache-for-Redis"><a href="#Scalability-of-Amazon-ElastiCache-for-Redis" class="headerlink" title="Scalability of Amazon ElastiCache for Redis"></a>Scalability of Amazon ElastiCache for Redis</h2><p>The above example of Redis cluster is a single node, we can add more readonly nodes for it.</p>
<h3 id="Add-Replication"><a href="#Add-Replication" class="headerlink" title="Add Replication"></a>Add Replication</h3><ol>
<li>Goto <em>Nodes</em> tab, select the node, then click <strong>Add Replication</strong><br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-1.png" alt="redis-replica-1.png"></li>
<li>Complete the information, to change the current <em>Single Node</em> cluster to <em>Single Shard and Single Node</em>:<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-2.png" alt="redis-replica-2.png"></li>
<li>Now the changes is finished, you can see the <em>Shards</em> column is become to <strong>1</strong> from 0<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-3.png" alt="redis-replica-3.png"></li>
<li>Goto <em>Nodes</em> tab, we can add more readonly node for this shard<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-4.png" alt="redis-replica-4.png"></li>
<li>Named the new node<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-5.png" alt="redis-replica-5.png"></li>
<li><p>The readonly replica node has been created<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-6.png" alt="redis-replica-6.png"></p>
<p>Now the new node is up, we add more replica nodes if needed<br><strong>Note</strong>: As the current instance is setup without the <em>Cluster Mode</em> is disabled, so we can only have one shard. <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/Replication.Redis-RedisCluster.html" target="_blank" rel="noopener">More info</a></p>
</li>
</ol>
<h3 id="Test-Replication"><a href="#Test-Replication" class="headerlink" title="Test Replication"></a>Test Replication</h3><h4 id="Write-Lambda-Function"><a href="#Write-Lambda-Function" class="headerlink" title="Write Lambda Function"></a>Write Lambda Function</h4><ol>
<li><p>Add new Lambda function to test the read write function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> redisReadOptions = &#123;</span><br><span class="line">    host: <span class="string">"firstreplicanode.cbmmpl.0001.use1.cache.amazonaws.com"</span>,</span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> redisWriteOptions = &#123;</span><br><span class="line">    host: <span class="string">"redistest.cbmmpl.0001.use1.cache.amazonaws.com"</span>,</span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReadClient</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'Start to connect to Redis Server'</span>)</span><br><span class="line">    <span class="keyword">var</span> client = redis.createClient(redisReadOptions);</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'Connected to Redis Server'</span>)</span><br><span class="line">    <span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWriteClient</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'Start to connect to Redis Server'</span>)</span><br><span class="line">    <span class="keyword">var</span> client = redis.createClient(redisWriteOptions);</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'Connected to Redis Server'</span>)</span><br><span class="line">    <span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"GET"</span>:</span><br><span class="line">    <span class="keyword">var</span> client = getReadClient();</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'get all'</span>)</span><br><span class="line">    client.hgetallAsync(GLOBAL_KEY).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">'Redis responses for get all: '</span>, res)</span><br><span class="line">        callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>: <span class="string">"This is a LIST operation, return all products"</span>, <span class="attr">ret</span>: res&#125;);</span><br><span class="line">        <span class="comment">// callback(null, &#123;body: "This is a LIST operation, return all products"&#125;);</span></span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"Failed to post data: "</span>, err)</span><br><span class="line">        callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">"Failed to get data"</span>&#125;);</span><br><span class="line">    &#125;).finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">'Disconnect to Redis'</span>);</span><br><span class="line">        client.quit();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"POST"</span>:</span><br><span class="line">    <span class="keyword">var</span> client = getWriteClient();</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">'Posting data for ['</span>, id, <span class="string">'] with value: '</span>, data);</span><br><span class="line">        client.hmsetAsync(GLOBAL_KEY, id, data).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.info(<span class="string">'Redis responses for post: '</span>, res)</span><br><span class="line">            callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>: <span class="string">"This is a CREATE operation and it's successful"</span>, <span class="attr">ret</span>: res&#125;);</span><br><span class="line">            <span class="comment">// callback(null, &#123;body: "This is a CREATE operation"&#125;);</span></span><br><span class="line">        &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">"Failed to post data: "</span>, err)</span><br><span class="line">            callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">"Failed to post data"</span>&#125;);</span><br><span class="line">        &#125;).finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.info(<span class="string">'Disconnect to Redis'</span>);</span><br><span class="line">            client.quit();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        callback(<span class="literal">null</span>, &#123;<span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">'no data is posted'</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Then deploy the code</p>
</li>
</ol>
<h4 id="Test-Lambda-Function-1"><a href="#Test-Lambda-Function-1" class="headerlink" title="Test Lambda Function"></a>Test Lambda Function</h4><ol>
<li>Check the data in readonly node<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-test-1.png" alt="redis-replica-test-1.png"></li>
<li>Write data to the read/write Primary node<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-test-2.png" alt="redis-replica-test-2.png"></li>
<li>The re-check the data in readonly node<br><img src="/2018/04/03/aws-elasti-cache-lambda/redis-replica-test-3.png" alt="redis-replica-test-3.png"><br><strong>WORKING!!!</strong></li>
</ol>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>No mater EC2 instance or Lambda function to access ElastiCache service, they must:</p>
<ol>
<li>Be in one VPC</li>
<li>Contain same <strong>Subnet</strong></li>
<li>Contain same <strong>Security Group</strong></li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Wang Yang</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/" title="Amazon ElastiCache for Redis in Lambda">https://blog.imyang.wang/2018/04/03/aws-elasti-cache-lambda/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/AWS/" rel="tag"># AWS</a>
          
            <a href="/tags/Redis/" rel="tag"># Redis</a>
          
            <a href="/tags/ElastiCache/" rel="tag"># ElastiCache</a>
          
            <a href="/tags/Lambda/" rel="tag"># Lambda</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/29/aws-elasti-cache-redis/" rel="next" title="Amazon ElastiCache for Redis">
                <i class="fa fa-chevron-left"></i> Amazon ElastiCache for Redis
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/08/aws-dynamodb-5-emr/" rel="prev" title="DynamoDB集成EMR">
                DynamoDB集成EMR <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/apple-touch-icon.png" alt="Wang Yang">
            
              <p class="site-author-name" itemprop="name">Wang Yang</p>
              <p class="site-description motion-element" itemprop="description">java, microservice</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Configure-VPC"><span class="nav-number">1.</span> <span class="nav-text">Configure VPC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Launch-a-Redis-Cluster"><span class="nav-number">2.</span> <span class="nav-text">Launch a Redis Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prepare-Role-to-Run-Lambda"><span class="nav-number">3.</span> <span class="nav-text">Prepare Role to Run Lambda</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lambda-Function"><span class="nav-number">4.</span> <span class="nav-text">Lambda Function</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-Lambda-Function"><span class="nav-number">4.1.</span> <span class="nav-text">Create Lambda Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-Lambda-Function-to-connect-to-Redis"><span class="nav-number">4.2.</span> <span class="nav-text">Write Lambda Function to connect to Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-Lambda-Function"><span class="nav-number">4.3.</span> <span class="nav-text">Test Lambda Function</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Test-writing-value-to-Redis-Server"><span class="nav-number">4.3.1.</span> <span class="nav-text">Test writing value to Redis Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Test-reading-value-from-Redis-Server"><span class="nav-number">4.3.2.</span> <span class="nav-text">Test reading value from Redis Server</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Access-ElastiCache-from-EC2"><span class="nav-number">5.</span> <span class="nav-text">Access ElastiCache from EC2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scalability-of-Amazon-ElastiCache-for-Redis"><span class="nav-number">6.</span> <span class="nav-text">Scalability of Amazon ElastiCache for Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-Replication"><span class="nav-number">6.1.</span> <span class="nav-text">Add Replication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-Replication"><span class="nav-number">6.2.</span> <span class="nav-text">Test Replication</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Write-Lambda-Function"><span class="nav-number">6.2.1.</span> <span class="nav-text">Write Lambda Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Test-Lambda-Function-1"><span class="nav-number">6.2.2.</span> <span class="nav-text">Test Lambda Function</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">7.</span> <span class="nav-text">Summary</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2011 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Yang</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.1"></script>


  
  


  
    <!-- LOCAL: You can save these files to your site and update links -->

  
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitmint.browser.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<style>
#gitment-container a {
  border-bottom: none;
}

</style>

<script>
  function renderGitment() {
    var gitment = new Gitmint({
      id: window.location.pathname,
      owner: 'wangyfm',
      repo: 'blog-gitment-comments',
      
        lang: 'zh-CN' || navigator.language || navigator.systemLanguage || navigator.userLanguage,
      
      oauth: {
      
      
        client_secret: 'c49270c62fdfbbb2d675670a601e5ef21b48e5a2',
      
        client_id: 'e53f9d3287adfa20f49e'
      }
    });
    gitment.render('gitment-container');
  }

  
    renderGitment();
  
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  
  <script src="/js/src/js.cookie.js?v=7.0.1"></script>
  <script src="/js/src/scroll-cookie.js?v=7.0.1"></script>


  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      
        background-color: #eee;
        background-image: linear-gradient(#fcfcfc, #eee);
        border: 1px solid #d5d5d5;
        border-radius: 3px;
      
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      
        right: 4px;
        top: 8px;
      
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1;
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; // Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.readOnly = true;
        ta.value = code;
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, code.length);
        ta.readOnly = false;
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); // For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
